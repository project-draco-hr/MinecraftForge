{
  if (quads == null) {
    quads=Collections.synchronizedSet(new LinkedHashSet<BakedQuad>());
    Set<Face> faces=Collections.synchronizedSet(new LinkedHashSet<Face>());
    TRSRTransformation transform=TRSRTransformation.identity();
    for (    Group g : this.model.getMatLib().getGroups().values()) {
      if (this.state instanceof OBJState) {
        OBJState state=(OBJState)this.state;
        if (state.parent != null && state.parent instanceof TRSRTransformation) {
          transform=(TRSRTransformation)state.parent;
        }
        if (state.getGroupNamesFromMap().contains(Group.ALL)) {
          state.visibilityMap.clear();
          for (          String s : this.model.getMatLib().getGroups().keySet()) {
            state.visibilityMap.put(s,state.operation.performOperation(true));
          }
        }
 else         if (state.getGroupNamesFromMap().contains(Group.ALL_EXCEPT)) {
          List<String> exceptList=state.getGroupNamesFromMap().subList(1,state.getGroupNamesFromMap().size());
          state.visibilityMap.clear();
          for (          String s : this.model.getMatLib().getGroups().keySet()) {
            if (!exceptList.contains(s)) {
              state.visibilityMap.put(s,state.operation.performOperation(true));
            }
          }
        }
 else {
          for (          String s : state.visibilityMap.keySet()) {
            state.visibilityMap.put(s,state.operation.performOperation(state.visibilityMap.get(s)));
          }
        }
        if (state.getGroupsWithVisibility(true).contains(g.getName())) {
          faces.addAll(g.applyTransform(transform));
        }
      }
 else       if (this.state instanceof TRSRTransformation) {
        transform=(TRSRTransformation)this.state;
        faces.addAll(g.applyTransform(transform));
      }
 else {
        transform=TRSRTransformation.identity();
        faces.addAll(g.applyTransform(transform));
      }
    }
    for (    Face f : faces) {
      if (this.model.getMatLib().materials.get(f.getMaterialName()).isWhite()) {
        for (        Vertex v : f.getVertices()) {
          if (!v.getMaterial().equals(this.model.getMatLib().getMaterial(v.getMaterial().getName()))) {
            v.setMaterial(this.model.getMatLib().getMaterial(v.getMaterial().getName()));
          }
        }
        sprite=ModelLoader.White.instance;
      }
 else       sprite=this.textures.get(f.getMaterialName());
      UnpackedBakedQuad.Builder builder=new UnpackedBakedQuad.Builder(format);
      builder.setQuadOrientation(EnumFacing.getFacingFromVector(f.getNormal().x,f.getNormal().y,f.getNormal().z));
      builder.setQuadColored();
      putVertexData(builder,f.verts[0],f.getNormal(),TextureCoordinate.getDefaultUVs()[0],sprite);
      putVertexData(builder,f.verts[1],f.getNormal(),TextureCoordinate.getDefaultUVs()[1],sprite);
      putVertexData(builder,f.verts[2],f.getNormal(),TextureCoordinate.getDefaultUVs()[2],sprite);
      putVertexData(builder,f.verts[3],f.getNormal(),TextureCoordinate.getDefaultUVs()[3],sprite);
      quads.add(builder.build());
    }
  }
  List<BakedQuad> quadList=Collections.synchronizedList(Lists.newArrayList(quads));
  return quadList;
}
