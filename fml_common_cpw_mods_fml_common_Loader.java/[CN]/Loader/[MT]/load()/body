{
  File minecraftDir=FMLCommonHandler.instance().getMinecraftRootDirectory();
  File modsDir=new File(minecraftDir,"mods");
  File configDir=new File(minecraftDir,"config");
  String canonicalModsPath;
  String canonicalConfigPath;
  try {
    canonicalMinecraftDir=minecraftDir.getCanonicalFile();
    canonicalModsPath=modsDir.getCanonicalPath();
    canonicalConfigPath=configDir.getCanonicalPath();
    canonicalConfigDir=configDir.getCanonicalFile();
  }
 catch (  IOException ioe) {
    log.severe(String.format("Failed to resolve mods directory mods %s",modsDir.getAbsolutePath()));
    log.throwing("fml.server.Loader","initialize",ioe);
    throw new LoaderException(ioe);
  }
  if (!modsDir.exists()) {
    log.fine(String.format("No mod directory found, creating one: %s",canonicalModsPath));
    try {
      modsDir.mkdir();
    }
 catch (    Exception e) {
      log.throwing("fml.server.Loader","initialize",e);
      throw new LoaderException(e);
    }
  }
  if (!configDir.exists()) {
    log.fine(String.format("No config directory found, creating one: %s",canonicalConfigPath));
    try {
      configDir.mkdir();
    }
 catch (    Exception e) {
      log.throwing("fml.server.Loader","initialize",e);
      throw new LoaderException(e);
    }
  }
  if (!modsDir.isDirectory()) {
    log.severe(String.format("Attempting to load mods from %s, which is not a directory",canonicalModsPath));
    LoaderException loaderException=new LoaderException();
    log.throwing("fml.server.Loader","initialize",loaderException);
    throw loaderException;
  }
  if (!configDir.isDirectory()) {
    log.severe(String.format("Attempting to load configuration from %s, which is not a directory",canonicalConfigPath));
    LoaderException loaderException=new LoaderException();
    log.throwing("fml.server.Loader","initialize",loaderException);
    throw loaderException;
  }
  state=State.LOADING;
  log.fine("Attempting to load mods contained in the minecraft jar file and associated classes");
  File[] minecraftSources=modClassLoader.getParentSources();
  if (minecraftSources.length == 1 && minecraftSources[0].isFile()) {
    log.fine(String.format("Minecraft is a file at %s, loading",minecraftSources[0].getAbsolutePath()));
    attemptFileLoad(minecraftSources[0],SourceType.CLASSPATH);
  }
 else {
    for (int i=0; i < minecraftSources.length; i++) {
      if (minecraftSources[i].isFile()) {
        log.fine(String.format("Found a minecraft related file at %s, loading",minecraftSources[i].getAbsolutePath()));
        attemptFileLoad(minecraftSources[i],SourceType.CLASSPATH);
      }
 else       if (minecraftSources[i].isDirectory()) {
        log.fine(String.format("Found a minecraft related directory at %s, loading",minecraftSources[i].getAbsolutePath()));
        attemptDirLoad(minecraftSources[i],"",SourceType.CLASSPATH);
      }
    }
  }
  log.fine("Minecraft jar mods loaded successfully");
  log.info(String.format("Loading mods from %s",canonicalModsPath));
  File[] modList=modsDir.listFiles();
  Arrays.sort(modList);
  for (  File modFile : modList) {
    if (modFile.isDirectory()) {
      log.fine(String.format("Found a directory %s, attempting to load it",modFile.getName()));
      boolean modFound=attemptDirLoad(modFile,"",SourceType.DIR);
      if (modFound) {
        log.fine(String.format("Directory %s loaded successfully",modFile.getName()));
      }
 else {
        log.info(String.format("Directory %s contained no mods",modFile.getName()));
      }
    }
 else {
      Matcher matcher=zipJar.matcher(modFile.getName());
      if (matcher.matches()) {
        log.fine(String.format("Found a zip or jar file %s, attempting to load it",matcher.group(0)));
        boolean modFound=attemptFileLoad(modFile,SourceType.JAR);
        if (modFound) {
          log.fine(String.format("File %s loaded successfully",matcher.group(0)));
        }
 else {
          log.info(String.format("File %s contained no mods",matcher.group(0)));
        }
      }
    }
  }
  if (state == State.ERRORED) {
    log.severe("A problem has occured during mod loading. Likely a corrupt jar is located in your mods directory");
    throw new LoaderException(capturedError);
  }
  log.info(String.format("Forge Mod Loader has loaded %d mods",mods.size()));
}
