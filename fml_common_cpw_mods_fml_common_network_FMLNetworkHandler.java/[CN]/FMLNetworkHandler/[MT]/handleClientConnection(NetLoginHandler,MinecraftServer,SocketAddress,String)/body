{
  if (!loginStates.containsKey(netLoginHandler)) {
    ServerConfigurationManager playerList=server.func_71203_ab();
    String kickReason=playerList.func_72399_a(address,userName);
    if (kickReason != null) {
      netLoginHandler.completeConnection(kickReason);
    }
    netLoginHandler.completeConnection("You don't have FML installed, or your installation is too old");
    return;
  }
  if (loginStates.get(netLoginHandler) == 1) {
    NetLoginHandler.func_72531_a(netLoginHandler,false);
    netLoginHandler.field_72538_b.func_74429_a(getModListRequestPacket());
    loginStates.put(netLoginHandler,2);
  }
 else   if (loginStates.get(netLoginHandler) == 2) {
    netLoginHandler.completeConnection(null);
    loginStates.remove(netLoginHandler);
  }
 else {
    netLoginHandler.completeConnection("There was a problem during FML negotiation");
    loginStates.remove(netLoginHandler);
  }
}
