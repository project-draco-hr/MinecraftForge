{
  int meta=itemstack.getItemDamage();
  int size=itemstack.stackSize;
  NBTTagCompound nbt=null;
  if (itemstack.getTagCompound() != null) {
    nbt=(NBTTagCompound)itemstack.getTagCompound().copy();
  }
  if (!(itemstack.getItem() instanceof ItemBucket)) {
    world.captureBlockSnapshots=true;
  }
  boolean flag=itemstack.getItem().onItemUse(itemstack,player,world,x,y,z,side,hitX,hitY,hitZ);
  world.captureBlockSnapshots=false;
  if (flag) {
    int newMeta=itemstack.getItemDamage();
    int newSize=itemstack.stackSize;
    NBTTagCompound newNBT=null;
    if (itemstack.getTagCompound() != null) {
      newNBT=(NBTTagCompound)itemstack.getTagCompound().copy();
    }
    net.minecraftforge.event.world.BlockEvent.PlaceEvent placeEvent=null;
    List<net.minecraftforge.common.util.BlockSnapshot> blockSnapshots=(List<net.minecraftforge.common.util.BlockSnapshot>)world.capturedBlockSnapshots.clone();
    world.capturedBlockSnapshots.clear();
    itemstack.setItemDamage(meta);
    itemstack.stackSize=size;
    if (nbt != null) {
      itemstack.setTagCompound(nbt);
    }
    if (blockSnapshots.size() > 1) {
      placeEvent=ForgeEventFactory.onPlayerMultiBlockPlace(player,blockSnapshots,net.minecraftforge.common.util.ForgeDirection.getOrientation(side));
    }
 else     if (blockSnapshots.size() == 1) {
      placeEvent=ForgeEventFactory.onPlayerBlockPlace(player,blockSnapshots.get(0),net.minecraftforge.common.util.ForgeDirection.getOrientation(side));
    }
    if (placeEvent != null && (placeEvent.isCanceled())) {
      flag=false;
      for (      net.minecraftforge.common.util.BlockSnapshot blocksnapshot : blockSnapshots) {
        world.restoringBlockSnapshots=true;
        blocksnapshot.restore(true,false);
        world.restoringBlockSnapshots=false;
      }
    }
 else {
      itemstack.setItemDamage(newMeta);
      itemstack.stackSize=newSize;
      if (nbt != null) {
        itemstack.setTagCompound(newNBT);
      }
      for (      net.minecraftforge.common.util.BlockSnapshot blocksnapshot : blockSnapshots) {
        int blockX=blocksnapshot.x;
        int blockY=blocksnapshot.y;
        int blockZ=blocksnapshot.z;
        int metadata=world.getBlockMetadata(blockX,blockY,blockZ);
        int updateFlag=blocksnapshot.flag;
        Block oldBlock=blocksnapshot.replacedBlock;
        Block newBlock=world.getBlock(blockX,blockY,blockZ);
        if (newBlock != null && !(newBlock.hasTileEntity(metadata))) {
          newBlock.onBlockAdded(world,blockX,blockY,blockZ);
        }
        world.markAndNotifyBlock(blockX,blockY,blockZ,null,oldBlock,newBlock,updateFlag);
      }
      player.addStat(StatList.objectUseStats[Item.getIdFromItem(itemstack.getItem())],1);
    }
  }
  world.capturedBlockSnapshots.clear();
  return flag;
}
