{
  TRSRTransformation ret=TRSRTransformation.identity();
  Key key=null;
  if (animation != null)   key=animation.getKeys().get(frame,node);
 else   if (key == null && node.getAnimation() != null && node.getAnimation() != animation)   key=node.getAnimation().getKeys().get(frame,node);
  if (key != null) {
    Node<?> parent=node.getParent();
    if (parent != null) {
      TRSRTransformation pm=cache.getUnchecked(Triple.<Animation,Node<?>,Integer>of(animation,node.getParent(),frame));
      ret=ret.compose(pm);
      ret=ret.compose(new TRSRTransformation(parent.getPos(),parent.getRot(),parent.getScale(),null));
    }
    ret=ret.compose(new TRSRTransformation(key.getPos(),key.getRot(),key.getScale(),null));
    Matrix4f rm=new TRSRTransformation(node.getPos(),node.getRot(),node.getScale(),null).getMatrix();
    rm.invert();
    ret=ret.compose(new TRSRTransformation(rm));
    if (parent != null) {
      rm=new TRSRTransformation(parent.getPos(),parent.getRot(),parent.getScale(),null).getMatrix();
      rm.invert();
      ret=ret.compose(new TRSRTransformation(rm));
    }
  }
  return ret;
}
