{
  if (state instanceof IExtendedBlockState) {
    IExtendedBlockState exState=(IExtendedBlockState)state;
    if (exState.getUnlistedNames().contains(B3DFrameProperty.instance)) {
      B3DState s=exState.getValue(B3DFrameProperty.instance);
      if (s != null) {
        IModelState parent=this.state;
        Animation newAnimation=s.getAnimation();
        if (parent instanceof B3DState) {
          B3DState ps=(B3DState)parent;
          parent=ps.getParent();
        }
        if (newAnimation == null) {
          newAnimation=node.getAnimation();
        }
        if (s.getFrame() == s.getNextFrame()) {
          return cache.getUnchecked(s.getFrame());
        }
        B3DState newState=new B3DState(newAnimation,s.getFrame(),s.getNextFrame(),s.getProgress(),parent);
        return new BakedWrapper(node,newState,smooth,gui3d,format,meshes,textures);
      }
    }
 else     if (exState.getUnlistedNames().contains(Properties.AnimationProperty)) {
      IModelState parent=this.state;
      if (parent instanceof B3DState) {
        B3DState ps=(B3DState)parent;
        parent=ps.getParent();
      }
      IModelState newState=exState.getValue(Properties.AnimationProperty);
      if (newState != null) {
        return new BakedWrapper(node,new ModelStateComposition(parent,newState),smooth,gui3d,format,meshes,textures);
      }
    }
  }
  return this;
}
