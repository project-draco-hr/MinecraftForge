{
  if (stack == null) {
    return true;
  }
  ItemStack result;
  int slot=player.inventory.currentItem;
  if ((result=FluidUtil.tryFillBucket(stack,tank,side,player)) != null || (result=FluidUtil.tryEmptyBucket(stack,tank,side,player)) != null) {
    if (!player.capabilities.isCreativeMode) {
      player.inventory.decrStackSize(slot,1);
      ItemHandlerHelper.giveItemToPlayer(player,result,slot);
    }
    if (player.inventoryContainer != null) {
      player.inventoryContainer.detectAndSendChanges();
    }
    return true;
  }
 else {
    ItemStack original=stack;
    ItemStack copy=stack.copy();
    stack=stack.copy();
    boolean changedBucket=false;
    if (ItemStack.areItemsEqual(stack,FluidContainerRegistry.EMPTY_BUCKET) && FluidRegistry.isUniversalBucketEnabled()) {
      stack=new ItemStack(ForgeModContainer.getInstance().universalBucket,copy.stackSize);
      changedBucket=true;
    }
    if (FluidUtil.tryFillFluidContainerItem(stack,tank,side,player) || FluidUtil.tryEmptyFluidContainerItem(stack,tank,side,player)) {
      original.stackSize--;
      if (player.capabilities.isCreativeMode) {
        player.inventory.setInventorySlotContents(slot,copy);
      }
 else {
        if (changedBucket && stack.stackSize != copy.stackSize) {
          copy.stackSize=stack.stackSize;
          player.inventory.setInventorySlotContents(slot,copy);
        }
 else {
          if (copy.stackSize > 1) {
            player.inventory.setInventorySlotContents(slot,stack);
          }
 else {
            player.inventory.setInventorySlotContents(slot,null);
            ItemHandlerHelper.giveItemToPlayer(player,stack,slot);
          }
        }
      }
      if (player.inventoryContainer != null) {
        player.inventoryContainer.detectAndSendChanges();
      }
      return true;
    }
  }
  return false;
}
